@using System.Security.Claims
@model mwowp.Web.Models.WorkOrder
@{
    ViewData["Title"] = "İş Emri Detayı";
    var availableEquipments = ViewBag.Equipments as IEnumerable<mwowp.Web.Models.Equipment>;
    var availableSpareParts = ViewBag.SpareParts as IEnumerable<mwowp.Web.Models.SparePart>;

    // Controller'dan gelen ayrıştırılmış listeler
    var approvedSpareParts = ViewBag.WorkOrderSpareParts as IEnumerable<mwowp.Web.Models.WorkOrderSparePart>;
    var requestedSpareParts = ViewBag.RequestedSpareParts as IEnumerable<mwowp.Web.Models.WorkOrderSparePart>;

    var isReadOnly = Model.Status == mwowp.Web.Models.WorkOrderStatus.Completed
                  || Model.Status == mwowp.Web.Models.WorkOrderStatus.Canceled
                  || Model.Status == mwowp.Web.Models.WorkOrderStatus.Inspected;

    var isTechnician = User.IsInRole("Technician");
    var isManager = User.IsInRole("Manager");
    var isOwnerUser = User.IsInRole("User") && User.FindFirst(ClaimTypes.NameIdentifier)?.Value == Model.CreatedByUserId;

    // Öncelik bazlı servis ücreti (örnek değerler)
    var efectivePriority = Model.Priority ?? PriorityLevel.Medium;
    decimal priorityCost = FeeDefinitions.GetFee(efectivePriority);

    // Onaylanmış yedek parça toplamı
    decimal sparePartsTotal = 0m;
    if (approvedSpareParts != null)
    {
        foreach (var sp in approvedSpareParts)
        {
            var unit = sp.SparePart?.UnitPrice ?? 0m;
            sparePartsTotal += unit * sp.QuantityUsed;
        }
    }

    // Toplam gider (yalnızca read-only durumlarda gösterilecek)
    var grandTotal = priorityCost + sparePartsTotal;
}

<h2>@Model.Title</h2>

@if (isReadOnly && (Model.Status != WorkOrderStatus.Canceled))
{
    <div class="alert alert-info d-flex justify-content-between align-items-center">
        <div>
            <strong>Toplam Gider:</strong>
            <span class="ms-1">@grandTotal.ToString()$</span>
            <span class="ms-3 text-muted">(Servis: @priorityCost.ToString()$ Yedek Parça: @sparePartsTotal.ToString()$)</span>
        </div>
        <a asp-action="DownloadInvoice" asp-controller="WorkOrder" asp-route-id="@Model.Id" class="btn btn-sm btn-outline-primary">
            Fatura İndir (TXT)
        </a>
    </div>
}

<div class="card mb-3">
    <div class="card-header">Genel Bilgiler</div>
    <div class="card-body">
        <dl class="row mb-0">
            <dt class="col-sm-3">Açıklama</dt>
            <dd class="col-sm-9">@Model.Description</dd>

            <dt class="col-sm-3">Öncelik</dt>
            <dd class="col-sm-9">@Model.Priority</dd>

            <dt class="col-sm-3">Durum</dt>
            <dd class="col-sm-9">@Model.Status</dd>

            <dt class="col-sm-3">Varlık (Asset)</dt>
            <dd class="col-sm-9">
                @Model.Asset?.Name (Id: @Model.AssetId)
            </dd>

            <dt class="col-sm-3">Oluşturan</dt>
            <dd class="col-sm-9">@Model.CreatedByUser?.UserName</dd>

            <dt class="col-sm-3">Atanan</dt>
            <dd class="col-sm-9">@Model.AssignedToUser?.UserName</dd>

            <dt class="col-sm-3">Oluşturulma</dt>
            <dd class="col-sm-9">@Model.CreatedAt.ToLocalTime()</dd>

            <dt class="col-sm-3">SLA Bitiş</dt>
            <dd class="col-sm-9">
                @if (Model.SLAEndTime.HasValue)
                {
                    var localSla = Model.SLAEndTime.Value.ToLocalTime();
                    var remaining = Model.SLAEndTime.Value - DateTime.UtcNow;
                    <span>@localSla</span>
                    <span class="ms-2 badge @(remaining.TotalSeconds <= 0 ? "bg-danger" : "bg-success")">
                        @(remaining.TotalSeconds <= 0 ? "Süre doldu" : $"Kalan: {(int)Math.Ceiling(remaining.TotalDays)} gün")
                    </span>
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </dd>

            @if (Model.CompletedAt.HasValue)
            {
                <dt class="col-sm-3">Tamamlanma</dt>
                <dd class="col-sm-9">@Model.CompletedAt.Value.ToLocalTime()</dd>
            }

            @if (!string.IsNullOrWhiteSpace(Model.RepairReport))
            {
                <dt class="col-sm-3">Onarım Raporu</dt>
                <dd class="col-sm-9"><pre class="mb-0" style="white-space:pre-wrap;">@Model.RepairReport</pre></dd>
            }
        </dl>
    </div>
</div>

@if (Model.Attachments?.Any() == true)
{
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Yüklenen Resimler (@Model.Attachments.Count)</span>
        </div>
        <div class="card-body">
            <div class="row g-3">
                @foreach (var att in Model.Attachments)
                {
                    <div class="col-6 col-sm-4 col-md-3">
                        <div class="border rounded p-1 h-100 d-flex flex-column">
                            <a href="~/@att.FilePath" target="_blank" title="Tam boyut">
                                <img src="~/@att.FilePath"
                                     alt="WorkOrder Image"
                                     class="img-fluid"
                                     style="object-fit:cover;aspect-ratio:1/1;" />
                            </a>
                            <small class="text-muted mt-1">
                                @att.CreatedAt.ToLocalTime()
                            </small>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}
else
{
    <div class="alert alert-light py-2">Bu iş emrine ait resim bulunmuyor.</div>
}

<div class="card mb-3">
    <div class="card-header">Geçmiş (History)</div>
    <div class="card-body p-0">
        <table class="table table-sm mb-0">
            <thead>
                <tr>
                    <th>Tarih/Saat</th>
                    <th>Kim</th>
                    <th>İşlem</th>
                    <th>Eski Değer</th>
                    <th>Yeni Değer</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.History?.Any() == true)
                {
                    foreach (var h in Model.History.OrderByDescending(x => x.CreatedAt))
                    {
                        <tr>
                            <td>@h.CreatedAt.ToLocalTime()</td>
                            <td>@(h.ChangedByUser?.UserName ?? "-")</td>
                            <td>@h.Action</td>
                            <td>@(string.IsNullOrWhiteSpace(h.OldValue) ? "-" : h.OldValue)</td>
                            <td>@(string.IsNullOrWhiteSpace(h.NewValue) ? "-" : h.NewValue)</td>
                        </tr>
                    }
                }
                else
                {
                    <tr><td colspan="5" class="text-muted">Geçmiş kaydı bulunmuyor.</td></tr>
                }
            </tbody>
        </table>
    </div>
</div>

<div class="row">
    <!-- Ekipmanlar -->
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Kullanılan Ekipmanlar</span>
            </div>
            <div class="card-body p-0">
                <table class="table table-sm mb-0">
                    <thead>
                        <tr>
                            <th>Ad</th>
                            <th>Not</th>
                            <th>Veriliş</th>
                            <th>İade</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.WorkOrderEquipments?.Any() == true)
                        {
                            foreach (var e in Model.WorkOrderEquipments)
                            {
                                <tr>
                                    <td>@e.Equipment?.Name</td>
                                    <td>@e.UsageNotes</td>
                                    <td>@e.AssignedAt.ToLocalTime()</td>
                                    <td>@(e.ReturnedAt.HasValue? e.ReturnedAt.Value.ToLocalTime().ToString() : "-")</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr><td colspan="4" class="text-muted">Kayıt yok.</td></tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="card-footer">
                @if (!isReadOnly && isTechnician)
                {
                    <form asp-action="AddEquipment" asp-controller="WorkOrder" method="post" class="row gy-2 gx-2">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.Id" />
                        <div class="col-5">
                            <select class="form-select form-select-sm" name="equipmentId" required>
                                <option value="">Ekipman seç...</option>
                                @if (availableEquipments != null)
                                {
                                    foreach (var eq in availableEquipments)
                                    {
                                        <option value="@eq.Id">@eq.Name</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-5">
                            <input type="text" name="usageNotes" class="form-control form-control-sm" placeholder="Kullanım notu" />
                        </div>
                        <div class="col-2 d-grid">
                            <button type="submit" class="btn btn-sm btn-primary">Ekle</button>
                        </div>
                    </form>
                }
                else
                {
                    <div class="text-muted small">Tamamlanan iş emrinde ekipman eklenemez.</div>
                }
            </div>
        </div>
    </div>

    <!-- Yedek Parçalar -->
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header">Onaylanmış Yedek Parçalar</div>
            <div class="card-body p-0">
                <table class="table table-sm mb-0">
                    <thead>
                        <tr>
                            <th>Parça</th>
                            <th>Miktar</th>
                            <th>Birim Fiyat</th>
                            <th>Toplam</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (approvedSpareParts != null && approvedSpareParts.Any())
                        {
                            foreach (var sp in approvedSpareParts)
                            {
                                var unit = sp.SparePart?.UnitPrice ?? 0m;
                                var total = unit * sp.QuantityUsed;
                                <tr>
                                    <td>@sp.SparePart?.Name</td>
                                    <td>@sp.QuantityUsed</td>
                                    <td>@unit.ToString()$</td>
                                    <td>@total.ToString()$</td>
                                </tr>
                            }
                        }
                        else
                        {
                            @if (isReadOnly)
                            {
                                <div class="text-muted small">Tamamlanan iş emrinde ekipman eklenemez.</div>
                            }
                            else
                            {
                                <div class="text-muted small">Sadece tekniker ekipman ekleyebilir.</div>
                            }
                        }
                    </tbody>
                </table>
            </div>
            <div class="card-footer">
                @if (!isReadOnly && isTechnician)
                {
                    <form asp-action="AddSparePart" asp-controller="WorkOrder" method="post" class="row gy-2 gx-2">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.Id" />
                        <div class="col-6">
                            <select class="form-select form-select-sm" name="sparePartId" required>
                                <option value="">Parça seç...</option>
                                @if (availableSpareParts != null)
                                {
                                    foreach (var part in availableSpareParts)
                                    {
                                        <option value="@part.Id">@part.Name (@part.UnitPrice.ToString()$)</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-4">
                            <input type="number" min="1" name="quantityUsed" class="form-control form-control-sm" placeholder="Miktar" required />
                        </div>
                        <div class="col-2 d-grid">
                            <button type="submit" class="btn btn-sm btn-primary">Talep Et</button>
                        </div>
                        <div class="col-12">
                            <small class="text-muted">Not: Bu işlem parça kullanımını direkt eklemez, kullanıcı onayına gönderir.</small>
                        </div>
                    </form>
                }
                else
                {
                    @if (isReadOnly)
                    {
                        <div class="text-muted small">Tamamlanan iş emrinde parça talep edilemez.</div>                
                    }
                    else
                    {
                        <div class="text-muted small">Sadece tekniker parça talep edebilir.</div>
                    }
                }
            </div>
        </div>
    </div>
</div>

@if (isOwnerUser && requestedSpareParts != null && requestedSpareParts.Any())
{
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Bekleyen Yedek Parça Talepleri</span>
            <small class="text-muted">Onayladığınızda stok düşer; reddederseniz iş emri iptal olur.</small>
        </div>
        <div class="card-body p-0">
            <table class="table table-sm mb-0">
                <thead>
                    <tr>
                        <th>Parça</th>
                        <th>Miktar</th>
                        <th>Birim Fiyat</th>
                        <th>Toplam</th>
                        <th>İşlem</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var req in requestedSpareParts)
                    {
                        var unit = req.SparePart?.UnitPrice ?? 0m;
                        var total = unit * req.QuantityUsed;
                        <tr>
                            <td>@req.SparePart?.Name</td>
                            <td>@req.QuantityUsed</td>
                            <td>@unit.ToString()$</td>
                            <td>@total.ToString()$</td>
                            <td class="d-flex gap-1">
                                <form asp-action="ApproveSparePart" asp-controller="WorkOrder" method="post" onsubmit="return confirm('Bu parça talebini onaylamak istediğinize emin misiniz?');">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@Model.Id" />
                                    <input type="hidden" name="workOrderSparePartId" value="@req.Id" />
                                    <button type="submit" class="btn btn-success btn-sm">Onayla</button>
                                </form>
                                <form asp-action="RejectSparePart" asp-controller="WorkOrder" method="post" onsubmit="return confirm('Reddeder ve iş emrini iptal edersiniz. Emin misiniz?');">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@Model.Id" />
                                    <input type="hidden" name="workOrderSparePartId" value="@req.Id" />
                                    <button type="submit" class="btn btn-danger btn-sm">Reddet</button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}
else if (isOwnerUser && (requestedSpareParts == null || !requestedSpareParts.Any()))
{
    <div class="alert alert-light py-2">Bekleyen yedek parça talebi bulunmuyor.</div>
}

<div class="d-flex gap-2">
    @if (isTechnician)
    {
        <a asp-action="MyTasks" asp-controller="WorkOrder" class="btn btn-secondary btn-sm">Listeye Dön</a>            
    }
    else if(isManager)
    {
        <a asp-action="Index" asp-controller="WorkOrder" class="btn btn-secondary btn-sm">Listeye Dön</a>
    }
    else
    {
        <a asp-action="MyOrders" asp-controller="WorkOrder" class="btn btn-secondary btn-sm">Listeye Dön</a>
    }

    @if (Model.Status != mwowp.Web.Models.WorkOrderStatus.Completed
        && Model.Status != mwowp.Web.Models.WorkOrderStatus.Inspected
        && Model.Status != mwowp.Web.Models.WorkOrderStatus.Canceled
        && isTechnician)
    {
        <form asp-action="Complete" asp-controller="WorkOrder" method="post" class="d-flex flex-column gap-2" onsubmit="return confirm('İş emrini tamamlamak istediğinize emin misiniz?');">
            @Html.AntiForgeryToken()
            <input type="hidden" name="id" value="@Model.Id" />
            <div class="form-floating">
                <textarea name="repairReport" class="form-control" style="height: 120px;" placeholder="Onarım raporunu giriniz..." required></textarea>
                <label>Onarım Raporu</label>
            </div>
            <div>
                <button type="submit" class="btn btn-success btn-sm">Raporla ve Tamamla</button>
            </div>
        </form>
    }
</div>